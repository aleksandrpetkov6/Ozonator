name: publish-nightly-release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: nightly-release
  cancel-in-progress: true

jobs:
  build_and_release:
    if: github.event_name != 'pull_request'
    runs-on: windows-latest

    defaults:
      run:
        shell: pwsh

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Build (dist)
        run: npm run dist -- --publish never

      - name: Prepare assets (exe + portable zip)
        id: prep
        run: |
          $ErrorActionPreference = "Stop"

          if (-not (Test-Path "release")) { throw "release/ folder not found" }

          $exe = Get-ChildItem -Path "release" -Recurse -File -Filter "*.exe" |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1
          if (-not $exe) { throw "No .exe found in release/" }

          $portableZip = Join-Path $PWD "portable-win-unpacked.zip"
          $winUnpacked = Get-ChildItem -Path "release" -Directory -Recurse |
            Where-Object { $_.Name -eq "win-unpacked" } |
            Select-Object -First 1

          $hasPortable = $false
          if ($winUnpacked) {
            if (Test-Path $portableZip) { Remove-Item $portableZip -Force }
            Compress-Archive -Path (Join-Path $winUnpacked.FullName "*") -DestinationPath $portableZip
            $hasPortable = $true
          }

          $stableExe = Join-Path $PWD "Ozonator.exe"
          Copy-Item $exe.FullName $stableExe -Force

          "exe_path=$stableExe" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "portable_ok=$($hasPortable.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "portable_zip=$portableZip" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: "Publish/Update nightly release (tag: nightly)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"

          # Recreate release each time so the tag 'nightly' always points to the current commit.
          try {
            gh release delete nightly --yes --cleanup-tag
          } catch {
            # ok if not exists
          }

          $assets = @("${{ steps.prep.outputs.exe_path }}")
          if ("${{ steps.prep.outputs.portable_ok }}" -eq "true") {
            $assets += "${{ steps.prep.outputs.portable_zip }}"
          }

          gh release create nightly $assets --title "nightly" --notes "Automated nightly build" --prerelease --target $env:GITHUB_SHA
