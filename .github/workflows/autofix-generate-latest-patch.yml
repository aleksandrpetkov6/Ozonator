name: AutoFix (generate latest.patch)

on:
  workflow_run:
    workflows:
      - "Windows CI (Озонатор)"
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: write
  actions: read

concurrency:
  group: autofix-${{ github.repository }}
  cancel-in-progress: true

jobs:
  autofix:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (
        github.event_name == 'workflow_run' &&
        github.event.workflow_run.conclusion != 'success' &&
        github.event.workflow_run.head_branch == 'main' &&
        github.event.workflow_run.event == 'push'
      )
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.PR_BOT_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Download artifacts/logs from failed run (best effort)
        if: github.event_name == 'workflow_run'
        uses: dawidd6/action-download-artifact@v11
        with:
          run_id: ${{ github.event.workflow_run.id }}
          path: _ci_logs
          if_no_artifact_found: warn

      - name: Generate latest.patch via AutoFix
        env:
          # Новый стандарт по Старт:
          AUTOFIX_PROVIDER: ${{ secrets.AUTOFIX_PROVIDER }}
          AUTOFIX_API_KEY: ${{ secrets.AUTOFIX_API_KEY }}
          AUTOFIX_MODEL: ${{ secrets.AUTOFIX_MODEL }}
          AUTOFIX_BASE_URL: ${{ secrets.AUTOFIX_BASE_URL }}

          # Совместимость со старым скриптом (он пока читает OPENAI_*):
          OPENAI_API_KEY: ${{ secrets.AUTOFIX_API_KEY }}
          OPENAI_MODEL: ${{ secrets.AUTOFIX_MODEL }}
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p _ci_logs

          node scripts/autofix_generate_patch.mjs \
            --logs-dir _ci_logs \
            --run-id "${{ github.event_name == 'workflow_run' && github.event.workflow_run.id || github.run_id }}" \
            --sha "${{ github.sha }}"

      - name: Validate latest.patch exists and is non-empty
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f patches/latest.patch ]; then
            echo "EMPTY_PATCH_GENERATED: patches/latest.patch was not created"
            exit 1
          fi
          if [ ! -s patches/latest.patch ]; then
            echo "EMPTY_PATCH_GENERATED: patches/latest.patch is empty"
            exit 1
          fi

      - name: Commit and push latest.patch
        env:
          PR_BOT_TOKEN: ${{ secrets.PR_BOT_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add patches/latest.patch
          git commit -m "autofix: regenerate latest.patch for ${{ github.sha }}" || {
            echo "No changes to commit"
            exit 0
          }

          git remote set-url origin "https://x-access-token:${PR_BOT_TOKEN}@github.com/${{ github.repository }}.git"
          git push origin HEAD:main
