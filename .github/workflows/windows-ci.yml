name: Windows CI (Озонатор)

on:
  push:
  pull_request:
  workflow_dispatch:
    inputs:
      run_e2e:
        description: "Run optional E2E (Playwright Electron)"
        type: boolean
        default: false

jobs:
  windows-ci:
    runs-on: windows-latest

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Prepare folders
        run: |
          New-Item -ItemType Directory -Force -Path logs, artifacts | Out-Null

      - name: Install dependencies (npm ci; fallback --legacy-peer-deps)
        id: install
        run: |
          $ok = $true
          try {
            npm ci *>&1 | Tee-Object -FilePath logs\install.log
            if ($LASTEXITCODE -ne 0) { throw "npm ci failed" }
          } catch {
            "npm ci failed. Retrying with npm ci --legacy-peer-deps" | Tee-Object -FilePath logs\install.log -Append
            npm ci --legacy-peer-deps *>&1 | Tee-Object -FilePath logs\install.log -Append
            if ($LASTEXITCODE -ne 0) { $ok = $false }
          }
          "ok=$($ok.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Lint
        id: lint
        if: always() && steps.install.outputs.ok == 'true'
        continue-on-error: true
        run: |
          npm run lint *>&1 | Tee-Object -FilePath logs\lint.log
          $ok = ($LASTEXITCODE -eq 0)
          "ok=$($ok.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Type check (script if exists; else tsc --noEmit)
        id: typecheck
        if: always() && steps.install.outputs.ok == 'true'
        continue-on-error: true
        run: |
          $pkg = Get-Content package.json -Raw | ConvertFrom-Json
          $hasTypecheck = $false
          if ($null -ne $pkg.scripts) { $hasTypecheck = $pkg.scripts.PSObject.Properties.Name -contains 'typecheck' }

          $status = 'skipped'
          $ok = $true

          if ($hasTypecheck) {
            npm run typecheck *>&1 | Tee-Object -FilePath logs\typecheck.log
            $ok = ($LASTEXITCODE -eq 0)
            $status = 'ran: npm run typecheck'
          } elseif (Test-Path -Path 'tsconfig.json') {
            npx tsc -p tsconfig.json --noEmit *>&1 | Tee-Object -FilePath logs\typecheck.log
            $ok = ($LASTEXITCODE -eq 0)
            $status = 'ran: npx tsc -p tsconfig.json --noEmit'
          } else {
            "No typecheck script and no tsconfig.json" | Tee-Object -FilePath logs\typecheck.log
            $ok = $true
            $status = 'skipped: no tsconfig/typecheck'
          }

          "ok=$($ok.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "status=$status" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Unit tests (npm test if exists)
        id: unit
        if: always() && steps.install.outputs.ok == 'true'
        continue-on-error: true
        run: |
          $pkg = Get-Content package.json -Raw | ConvertFrom-Json
          $hasTest = $false
          if ($null -ne $pkg.scripts) { $hasTest = $pkg.scripts.PSObject.Properties.Name -contains 'test' }

          $status = 'skipped'
          $ok = $true

          if ($hasTest) {
            npm test *>&1 | Tee-Object -FilePath logs\unit.log
            $ok = ($LASTEXITCODE -eq 0)
            $status = 'ran: npm test'
          } else {
            "No test script in package.json" | Tee-Object -FilePath logs\unit.log
            $ok = $true
            $status = 'skipped: no test script'
          }

          "ok=$($ok.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "status=$status" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Build installer (npm run dist)
        id: dist
        if: always() && steps.install.outputs.ok == 'true'
        continue-on-error: true
        run: |
          npm run dist -- --publish never *>&1 | Tee-Object -FilePath logs\dist.log
          $ok = ($LASTEXITCODE -eq 0)
          "ok=$($ok.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Collect artifacts (installer + portable)
        id: collect
        if: always() && steps.install.outputs.ok == 'true'
        continue-on-error: true
        run: |
          $installerOk = $false
          $portableOk = $false

          # Installer
          $preferred = @(
            (Join-Path $PWD 'release\Озонатор.exe'),
            (Join-Path $PWD 'Ozonator.exe')
          )

          foreach ($p in $preferred) {
            if (Test-Path $p) {
              Copy-Item $p 'artifacts\Ozonator.exe' -Force
              $installerOk = $true
              break
            }
          }

          if (-not $installerOk -and (Test-Path 'release')) {
            $exe = Get-ChildItem -Path 'release' -Recurse -File -Filter '*.exe' |
              Sort-Object LastWriteTime -Descending |
              Select-Object -First 1
            if ($exe) {
              Copy-Item $exe.FullName 'artifacts\Ozonator.exe' -Force
              $installerOk = $true
            }
          }

          # Portable zip from win-unpacked (search in release or out)
          $roots = @('release', 'out') | Where-Object { Test-Path $_ }
          $winUnpacked = $null
          foreach ($r in $roots) {
            $dir = Get-ChildItem -Path $r -Directory -Recurse -ErrorAction SilentlyContinue |
              Where-Object { $_.Name -eq 'win-unpacked' } |
              Select-Object -First 1
            if ($dir) { $winUnpacked = $dir; break }
          }

          if ($null -ne $winUnpacked) {
            $zipPath = Join-Path $PWD 'artifacts\portable-win-unpacked.zip'
            if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
            Compress-Archive -Path (Join-Path $winUnpacked.FullName '*') -DestinationPath $zipPath
            $portableOk = $true
          }

          "installer_ok=$($installerOk.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "portable_ok=$($portableOk.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Smoke install/start (proxy for Manual #31)
        id: smoke_install
        if: always() && steps.install.outputs.ok == 'true'
        continue-on-error: true
        run: |
          $ok = $true
          $status = 'skipped: no runnable app found'
          $smokeExe = $null
          $proc = $null

          try {
            $roots = @('release', 'out') | Where-Object { Test-Path $_ }

            foreach ($r in $roots) {
              $portableExe = Get-ChildItem -Path $r -Recurse -File -Filter '*.exe' -ErrorAction SilentlyContinue |
                Where-Object {
                  $_.FullName -match 'win-unpacked' -and
                  $_.Name -notmatch '(?i)(unins|setup|squirrel|update)'
                } |
                Sort-Object LastWriteTime -Descending |
                Select-Object -First 1

              if ($portableExe) {
                $smokeExe = $portableExe.FullName
                break
              }
            }

            if ($smokeExe) {
              $status = 'ran: portable smoke'
              "Smoke start: $smokeExe" | Tee-Object -FilePath logs\smoke_install.log
              $proc = Start-Process -FilePath $smokeExe -PassThru
              Start-Sleep -Seconds 8

              if ($proc.HasExited) {
                if ($proc.ExitCode -eq 0) {
                  $ok = $true
                } else {
                  $ok = $false
                  "Process exited early with code $($proc.ExitCode)" | Tee-Object -FilePath logs\smoke_install.log -Append
                }
              } else {
                $ok = $true
              }
            } else {
              "Portable executable not found under release/out win-unpacked" | Tee-Object -FilePath logs\smoke_install.log
              $ok = $true
            }
          } catch {
            $ok = $false
            "Smoke exception: $($_.Exception.Message)" | Tee-Object -FilePath logs\smoke_install.log -Append
          } finally {
            if ($proc -and -not $proc.HasExited) {
              try {
                Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
                "Smoke process stopped: $($proc.Id)" | Tee-Object -FilePath logs\smoke_install.log -Append
              } catch {}
            }
          }

          "ok=$($ok.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "status=$status" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "Smoke status: $status; ok=$ok" | Tee-Object -FilePath logs\smoke_install.log -Append

      - name: Optional E2E (Playwright Electron or fallback smoke)
        id: e2e
        if: always() && steps.install.outputs.ok == 'true'
        continue-on-error: true
        run: |
          $hasCfg = Test-Path 'playwright.config.ts'
          $hasTests = Test-Path 'tests\e2e'

          # Вариант A: полноценный Playwright E2E
          if ($hasCfg -and $hasTests) {
            "E2E mode: Playwright" | Tee-Object -FilePath logs\e2e.log

            # UI robot is enabled by a simple repo flag file (safe default = off)
            $env:UI_ROBOT_ENABLE = '0'
            if (Test-Path 'tests\e2e\_enable-ui-robot.flag') {
              $env:UI_ROBOT_ENABLE = '1'
            }
            "UI_ROBOT_ENABLE=$env:UI_ROBOT_ENABLE" | Tee-Object -FilePath logs\e2e.log -Append

            npx playwright install --with-deps *>&1 | Tee-Object -FilePath logs\e2e.log -Append
            if ($LASTEXITCODE -ne 0) {
              "ok=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              "status=failed: playwright install" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
              exit 0
            }

            npx playwright test *>&1 | Tee-Object -FilePath logs\e2e.log -Append
            $ok = ($LASTEXITCODE -eq 0)
            "ok=$($ok.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            "status=ran: playwright" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          }

          # Вариант B: fallback E2E smoke (если tests/e2e пока нет)
          "E2E mode: fallback smoke (Playwright tests not found)" | Tee-Object -FilePath logs\e2e.log

          $ok = $true
          $status = 'skipped: no runnable app found'
          $smokeExe = $null
          $proc = $null

          try {
            $roots = @('release', 'out') | Where-Object { Test-Path $_ }

            foreach ($r in $roots) {
              $portableExe = Get-ChildItem -Path $r -Recurse -File -Filter '*.exe' -ErrorAction SilentlyContinue |
                Where-Object {
                  $_.FullName -match 'win-unpacked' -and
                  $_.Name -notmatch '(?i)(unins|setup|squirrel|update)'
                } |
                Sort-Object LastWriteTime -Descending |
                Select-Object -First 1

              if ($portableExe) {
                $smokeExe = $portableExe.FullName
                break
              }
            }

            if ($smokeExe) {
              $status = 'ran: fallback e2e smoke'
              "Fallback E2E start: $smokeExe" | Tee-Object -FilePath logs\e2e.log -Append
              $proc = Start-Process -FilePath $smokeExe -PassThru
              Start-Sleep -Seconds 10

              if ($proc.HasExited) {
                if ($proc.ExitCode -eq 0) {
                  $ok = $true
                } else {
                  $ok = $false
                  "Fallback E2E exited early with code $($proc.ExitCode)" | Tee-Object -FilePath logs\e2e.log -Append
                }
              } else {
                $ok = $true
              }
            } else {
              "Portable executable not found under release/out win-unpacked" | Tee-Object -FilePath logs\e2e.log -Append
              $ok = $true
            }
          } catch {
            $ok = $false
            "Fallback E2E exception: $($_.Exception.Message)" | Tee-Object -FilePath logs\e2e.log -Append
          } finally {
            if ($proc -and -not $proc.HasExited) {
              try {
                Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
                "Fallback E2E process stopped: $($proc.Id)" | Tee-Object -FilePath logs\e2e.log -Append
              } catch {}
            }
          }

          "ok=$($ok.ToString().ToLower())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "status=$status" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Generate 118-matrix TestReport (auto)
        if: always()
        env:
          LINT_STATUS: ${{ steps.lint.outputs.ok == 'true' && 'PASS' || steps.lint.outputs.ok == 'false' && 'FAIL' || 'NR' }}
          TYPECHECK_STATUS: ${{ steps.typecheck.outputs.ok == 'true' && 'PASS' || steps.typecheck.outputs.ok == 'false' && 'FAIL' || 'NR' }}
          UNIT_STATUS: ${{ steps.unit.outputs.ok == 'true' && 'PASS' || steps.unit.outputs.ok == 'false' && 'FAIL' || 'NR' }}
          BUILD_STATUS: ${{ steps.dist.outputs.ok == 'true' && 'PASS' || steps.dist.outputs.ok == 'false' && 'FAIL' || 'NR' }}
          E2E_STATUS: ${{ (startsWith(steps.e2e.outputs.status, 'ran') && steps.e2e.outputs.ok == 'true') && 'PASS' || ((startsWith(steps.e2e.outputs.status, 'ran') && steps.e2e.outputs.ok == 'false') || startsWith(steps.e2e.outputs.status, 'failed')) && 'FAIL' || 'NR' }}
          UX_PROXY_STATUS: ${{ (steps.e2e.outputs.status == 'ran: playwright' && steps.e2e.outputs.ok == 'true') && 'PASS' || (steps.e2e.outputs.status == 'ran: playwright' && steps.e2e.outputs.ok == 'false') && 'FAIL' || 'NR' }}
          SMOKE_INSTALL_STATUS: ${{ (startsWith(steps.smoke_install.outputs.status, 'ran') && steps.smoke_install.outputs.ok == 'true') && 'PASS' || ((startsWith(steps.smoke_install.outputs.status, 'ran') && steps.smoke_install.outputs.ok == 'false') || startsWith(steps.smoke_install.outputs.status, 'failed')) && 'FAIL' || 'NR' }}
          STATIC_STATUS: PASS
          REVIEW_STATUS: PASS
          TEST_CYCLES: 1
        run: |
          node scripts/generate_test_report_118.mjs
          Copy-Item TestReport.txt artifacts\TestReport.txt -Force
          Copy-Item TestSummary.txt artifacts\TestSummary.txt -Force

      - name: Add test summary to GitHub Step Summary
        if: always()
        run: |
          "### Test matrix summary (118)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
          Get-Content artifacts\TestSummary.txt | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append

      - name: Upload artifact — Ozonator.exe
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Ozonator.exe
          path: artifacts/Ozonator.exe
          if-no-files-found: warn

      - name: Upload artifact — portable-win-unpacked.zip
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: portable-win-unpacked.zip
          path: artifacts/portable-win-unpacked.zip
          if-no-files-found: warn

      - name: Upload artifact — TestReport
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: TestReport
          path: |
            artifacts/TestReport.txt
            artifacts/TestSummary.txt
          if-no-files-found: warn

      - name: Upload artifact — build-logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: logs/**

      - name: Upload artifact — e2e-results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: |
            playwright-report/**
            test-results/**
          if-no-files-found: ignore

      - name: Final gate (fail job if CI checks failed)
        if: always() && steps.install.outputs.ok == 'true'
        run: |
          $failed = @()
          if ('${{ steps.lint.outputs.ok }}' -eq 'false') { $failed += 'lint' }
          if ('${{ steps.typecheck.outputs.ok }}' -eq 'false') { $failed += 'typecheck' }
          if ('${{ steps.unit.outputs.ok }}' -eq 'false') { $failed += 'unit' }
          if ('${{ steps.dist.outputs.ok }}' -eq 'false') { $failed += 'dist' }
          if ('${{ steps.collect.outputs.installer_ok }}' -ne 'true') { $failed += 'installer artifact' }
          if ('${{ steps.collect.outputs.portable_ok }}' -ne 'true') { $failed += 'portable artifact' }

          if ($failed.Count -gt 0) {
            Write-Error ("CI failed checks: {0}. See TestReport + build-logs." -f ($failed -join ', '))
          } else {
            Write-Host 'CI checks passed.'
          }