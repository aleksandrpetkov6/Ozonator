name: Apply patch and open PR

on:
  workflow_dispatch:
    inputs:
      patch_path:
        description: "Path to patch file in repo (.patch)"
        required: true
        default: "patches/latest.patch"
      base_branch:
        description: "Base branch (usually main)"
        required: true
        default: "main"
  push:
    branches: [main]
    paths:
      - patches/latest.patch

concurrency:
  group: apply-patch-pr
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

env:
  PATCH_PATH: ${{ github.event_name == 'workflow_dispatch' && inputs.patch_path || 'patches/latest.patch' }}
  BASE_BRANCH: ${{ github.event_name == 'workflow_dispatch' && inputs.base_branch || 'main' }}
  TRIGGER: ${{ github.event_name }}

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.BASE_BRANCH }}

      - name: Require PR_BOT_TOKEN
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.PR_BOT_TOKEN }}" ]; then
            echo "::error::Missing required secret PR_BOT_TOKEN (fine-grained PAT)."
            exit 1
          fi

      - name: Validate patch file exists
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f "${{ env.PATCH_PATH }}" ]; then
            echo "::error::Patch file not found: ${{ env.PATCH_PATH }}"
            echo "Tip: add it via GitHub web UI → Add file → Upload files (do not paste)."
            echo ""
            echo "Files in patches/:"
            ls -la patches || true
            exit 1
          fi

      - name: Materialize patch
        id: mat
        shell: bash
        run: |
          set -euo pipefail
          SRC="${{ env.PATCH_PATH }}"
          OUT="/tmp/patch.patch"
          cp "$SRC" "$OUT"
          echo "out=$OUT" >> "$GITHUB_OUTPUT"
          echo "---- PATCH PREVIEW (first 60 lines) ----"
          sed -n '1,60p' "$OUT" || true

      - name: Check patch applicability
        id: chk
        shell: bash
        run: |
          set -euo pipefail
          PATCH="${{ steps.mat.outputs.out }}"

          if git apply --check "$PATCH"; then
            echo "status=apply" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # If reverse-check works, the patch is likely already applied.
          if git apply --check -R "$PATCH"; then
            echo "status=already_applied" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "::error::Patch does not apply (and is not detected as already applied)."
          echo "status=fail" >> "$GITHUB_OUTPUT"
          exit 1

      - name: Apply patch
        if: steps.chk.outputs.status == 'apply'
        shell: bash
        run: |
          set -euo pipefail
          git apply --whitespace=fix "${{ steps.mat.outputs.out }}"

      - name: Create Pull Request
        if: steps.chk.outputs.status == 'apply'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PR_BOT_TOKEN }}
          branch: bot/apply-patch-${{ github.run_id }}-${{ github.run_attempt }}
          base: ${{ env.BASE_BRANCH }}
          title: "Apply patch: ${{ env.PATCH_PATH }}"
          commit-message: "Apply patch: ${{ env.PATCH_PATH }}"
          body: |
            Automated patch apply.
            Trigger: ${{ env.TRIGGER }}
            Source patch: ${{ env.PATCH_PATH }}

      - name: Enable auto-merge (squash)
        if: steps.cpr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.PR_BOT_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash

      - name: Summary
        if: always()
        shell: bash
        run: |
          STATUS="${{ steps.chk.outputs.status }}"
          echo "Trigger: ${{ env.TRIGGER }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Patch: ${{ env.PATCH_PATH }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Status: ${STATUS:-unknown}" >> "$GITHUB_STEP_SUMMARY"

          if [ "${STATUS:-}" = "already_applied" ]; then
            echo "No changes: patch appears to be already applied to '${{ env.BASE_BRANCH }}'." >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "PR: ${{ steps.cpr.outputs.pull-request-url }}" >> "$GITHUB_STEP_SUMMARY"
